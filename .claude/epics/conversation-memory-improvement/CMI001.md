---
id: CMI001
epic: conversation-memory-improvement
title: "实现Backend Internal API路由和端点"
status: open
github_url: https://github.com/hedwig-44/HEARTALK-AI/issues/16
priority: high
created: 2025-09-18T04:39:23Z
updated: 2025-09-18T05:26:28Z
assignee: unassigned
labels: [backend, api, internal]
dependencies: []
depends_on: []
parallel: true
conflicts_with: []
estimated_hours: 16
actual_hours: 0
---

# Task: 实现Backend Internal API路由和端点

## Description
创建HearTalk Backend的Internal API模块，提供AI服务专用的对话历史和用户上下文查询接口。实现核心的3个API端点：对话历史查询、用户上下文查询和健康检查。

## Acceptance Criteria
- [ ] 创建 `backend/src/routes/internal.js` 文件包含所有Internal API路由
- [ ] 实现 `GET /internal/api/v1/conversations/{id}/history` 端点
- [ ] 实现 `GET /internal/api/v1/users/{id}/context` 端点  
- [ ] 实现 `GET /internal/api/v1/health` 端点
- [ ] 所有端点支持分页查询（limit, offset参数）
- [ ] 响应格式统一为标准JSON格式：`{success: boolean, data: object, meta?: object}`
- [ ] 实现完整的错误处理和HTTP状态码
- [ ] 添加详细的请求日志记录

## Technical Details
- **文件位置**: `/Users/lulu/Documents/Work/ai_chat_v2/HEARTALK-BE/backend/src/routes/internal.js`
- **依赖服务**: conversationService, messageService, userService (已存在)
- **数据源**: 现有conversations和messages表
- **响应格式**: 标准化JSON响应，包含success状态和data字段
- **查询优化**: 使用ASC排序确保对话时间顺序正确
- **参数验证**: conversationId和userId必须为正整数，limit范围1-100

## Dependencies
- [ ] 现有conversationService可正常工作
- [ ] 现有messageService可正常工作  
- [ ] 现有userService可正常工作
- [ ] 数据库连接正常且有测试数据

## Effort Estimate
- Size: M
- Hours: 16小时
- Parallel: true (可与认证中间件并行开发)

## Definition of Done
- [ ] 所有3个API端点实现完成
- [ ] API响应格式符合规范
- [ ] 错误处理覆盖所有异常情况
- [ ] 日志记录详细且格式统一
- [ ] 代码通过本地测试验证
- [ ] API文档注释完整
- [ ] 性能满足 < 200ms响应时间要求