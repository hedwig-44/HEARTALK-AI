---
id: CMI005
epic: conversation-memory-improvement
title: "配置部署环境和服务重启"
status: open
github_url: https://github.com/hedwig-44/HEARTALK-AI/issues/20
priority: medium
created: 2025-09-18T04:39:23Z
updated: 2025-09-18T05:26:28Z
assignee: unassigned
labels: [deployment, configuration, devops]
dependencies: []
depends_on: []
parallel: true
conflicts_with: []
estimated_hours: 4
actual_hours: 0
---

# Task: 配置部署环境和服务重启

## Description
更新HEARTALK-BE项目的配置文件，将新的Internal API路由集成到主应用中，配置必要的环境变量，并执行服务的热重启部署。确保生产环境配置正确且安全。

## Acceptance Criteria
- [ ] 更新 `HEARTALK-BE/backend/src/app.js` 添加Internal API路由注册
- [ ] 验证环境变量 `HEARTALK_API_KEY` 和 `JWT_SECRET` 配置
- [ ] 从ccpm同步所有修改到HEARTALK-BE项目
- [ ] 执行Backend服务重启（docker-compose restart backend）
- [ ] 执行AI服务重启（docker-compose restart ai-service）
- [ ] 验证服务重启后正常运行
- [ ] 确认Internal API路由可访问
- [ ] 准备回滚方案和备份

## Technical Details
- **app.js修改位置**: 
  - 路由导入部分（约第20行）：`const internalRoutes = require('./routes/internal');`
  - API路由配置部分（约第83行）：`app.use('/internal/api/v1', internalRoutes);`
- **环境变量**: 确保 `.env` 文件包含必要的API密钥
- **同步路径**: 
  - `backend/src/routes/internal.js` → `HEARTALK-AI/backend/src/routes/internal.js`
  - `ai-service/src/services/BackendApiClient.js` → `HEARTALK-AI/ai-service/src/services/BackendApiClient.js`
- **部署方式**: Docker Compose热重启，无停机时间
- **回滚准备**: git备份当前版本，准备快速回滚命令

## Dependencies
- [ ] 所有代码修改已在ccpm中完成
- [ ] Docker环境正常运行
- [ ] 有管理员权限执行部署操作

## Effort Estimate
- Size: S
- Hours: 4小时
- Parallel: true (可与开发任务并行准备)

## Definition of Done
- [ ] app.js文件成功更新，包含Internal API路由
- [ ] 环境变量配置正确且安全
- [ ] 所有代码文件同步完成
- [ ] Backend和AI服务重启成功
- [ ] 服务运行状态正常（docker ps检查）
- [ ] Internal API路由可访问（curl测试）
- [ ] 回滚方案文档化并验证
- [ ] 部署日志记录完整