---
id: CMI002
epic: conversation-memory-improvement
title: "实现Internal API认证中间件"
status: open
github_url: https://github.com/hedwig-44/HEARTALK-AI/issues/17
priority: high
created: 2025-09-18T04:39:23Z
updated: 2025-09-18T05:26:28Z
assignee: unassigned
labels: [backend, security, middleware]
dependencies: []
depends_on: [CMI001]
parallel: false
conflicts_with: [CMI001]
estimated_hours: 8
actual_hours: 0
---

# Task: 实现Internal API认证中间件

## Description
实现API Key验证中间件，确保只有授权的内部服务（AI服务）可以访问Internal API端点。提供安全的服务间通信机制，包含完整的错误处理和安全日志记录。

## Acceptance Criteria
- [ ] 在 `internal.js` 中实现 `validateInternalApiKey` 中间件函数
- [ ] 验证请求头中的 `x-api-key` 字段
- [ ] 与环境变量 `HEARTALK_API_KEY` 进行匹配验证
- [ ] 实现安全的错误响应，避免泄露敏感信息
- [ ] 记录所有认证失败的详细日志（IP、路径、时间）
- [ ] 处理API Key未配置的异常情况
- [ ] 返回标准化的错误响应格式

## Technical Details
- **实现位置**: 在CMI001创建的 `internal.js` 文件中
- **环境变量**: 依赖 `HEARTALK_API_KEY` 环境变量
- **安全措施**: 
  - 日志中只记录API Key前8位用于调试
  - 详细记录访问IP和User-Agent
  - 标准化错误码：MISSING_API_KEY, INVALID_API_KEY, CONFIG_ERROR
- **中间件位置**: 应用在所有Internal API路由之前

## Dependencies
- [ ] CMI001任务完成，internal.js文件已创建
- [ ] 环境变量HEARTALK_API_KEY已配置
- [ ] Logger工具可正常使用

## Effort Estimate
- Size: S
- Hours: 8小时
- Parallel: false (需要CMI001的基础代码)

## Definition of Done
- [ ] 中间件函数实现完成
- [ ] 所有安全验证逻辑正确
- [ ] 错误处理覆盖所有异常情况
- [ ] 安全日志记录详细且不泄露敏感信息
- [ ] 中间件已正确应用到所有Internal API路由
- [ ] 通过安全测试验证（正确API Key通过，错误Key拒绝）